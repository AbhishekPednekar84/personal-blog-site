<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="Abhishek Pednekar" />
    <meta name="generator" content="Pelican (VoidyBootstrap theme)" />

    <title>Deploying a Python application on a Linux server - Part II - Code Disciples</title>

   
        <link rel="stylesheet"
              href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
              integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
              crossorigin="anonymous" />
      <link rel="stylesheet"
            href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
            integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
            crossorigin="anonymous">


      <link rel="stylesheet" href="https://codedisciples.in/theme/css/blog.css" />
      <link rel="stylesheet" href="https://codedisciples.in/theme/css/tomorrow_night.css" />

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js" integrity="sha384-FFgGfda92tXC8nCNOxrCQ3R8x1TNkMFqDZVQdDaaJiiVbjkPBXIJBx0o7ETjy8Bh" crossorigin="anonymous"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js" integrity="sha384-ZoaMbDF+4LeFxg6WdScQ9nnR1QC2MIRxA1O9KWEXQwns1G8UNyIEZIQidzb0T1fo" crossorigin="anonymous"></script>
    <![endif]-->

    <link rel="shortcut icon" href="https://codedisciples.in/static/images/favicon.ico" />
        <link href="https://codedisciples.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Code Disciples Atom Feed" />
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-145611420-1', '');
  ga('send', 'pageview');

</script>
  </head>

  <body>
   
    <nav class="navbar navbar-default">
      <div class="container">
	   <div class="navbar-header">
		<button type="button" class="navbar-toggle" 
				data-toggle="collapse" data-target="#main-navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="https://codedisciples.in/" rel="home">
          <i class="fas fa-home fa-fw fa-lg"> </i> </a>
       </div>

      <div class="collapse navbar-collapse" id="main-navbar-collapse">
        <ul class="nav navbar-nav">
            <li class="divider"></li>
            <li class="">
              <a href="https://codedisciples.in/archives.html">Archives</a>
            </li>
          <li class="divider"></li>
            <li><a href="https://codedisciples.in/feeds/all.atom.xml" 
                   type="application/atom+xml" rel="alternate">
                <i class="fas fa-rss fa-fw fa-lg"></i> </a></li>
        </ul> <!-- /nav -->
      </div> <!-- /navbar-collapse -->
	  </div> <!-- /container -->
    </nav> <!-- /navbar -->

	<div class="jumbotron" id="overview">
	  <div class="container">
		<h1>Code Disciples</h1>
		<p class="lead">A blog for all things code</p>
	  </div>
	</div>

    <div class="container" id="main-container">
      <div class="row">
        <div class="col-md-9" id="content">
<article itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
  <header class="article-header">
<abbr class="article-header-date">
  Tue 10 December 2019
</abbr> <h1>
  <a href="https://codedisciples.in/linux-vps-deployment2.html" rel="bookmark"
     title="Permalink to Deploying a Python application on a Linux server - Part II">
    Deploying a Python application on a Linux server - Part II
  </a>
</h1><div class="article-header-info">
  <p>
      Posted by <a href="https://codedisciples.in/author/abhishek-pednekar.html">Abhishek Pednekar</a>
    in 
    <a href="https://codedisciples.in/category/linux.html">
      Linux</a>
    &nbsp;&nbsp;
  </p>
</div> <!-- /.article-header-info -->  </header>
  <div class="content-body" itemprop="text articleBody">
	<p>In the <a href="https://www.codedisciples.in/linux-vps-deployment1.html">part one</a> of this two-parter, we performed the initial set up to deploy a Flask application on a bare-bones virtual private server (VPS). In this post, we will deploy the actual application and get it up and running with <strong>nginx</strong> and <strong>gunicorn</strong>.</p>
<p>The post assumes that the reader is familiar with the basics of Linux and Flask. </p>
<p><a href="https://github.com/AbhishekPednekar84/flask_demo_app">Click here</a> to download the source code of our Flask application. An important thing to note is that we will be using a <code>.env</code> file to configure our environment variables (see <code>.env.example</code> in the repository). So these variables will need to be configured before deploying the application on the server. Since the application uses reCAPTCHA during login, we will need to register on <a href="ttps://www.google.com/recaptcha/">Google reCAPTCHA</a> to obtain the public and private keys. Also, for the database, we are using a Postgres database provisioned by <a href="https://www.elephantsql.com/">ElephantSQL</a>. The <code>DATABASE_URL</code> variable in the <code>.env</code> file will need to be modified depending on the database in use.</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">Environment</span> <span class="n">Variables</span>

<span class="n">SECRET_KEY</span><span class="o">=</span>
<span class="n">DATABASE_URL</span><span class="o">=</span>
<span class="n">RECAPTCHA_PUBLIC_KEY</span><span class="o">=</span>
<span class="n">RECAPTCHA_PRIVATE_KEY</span><span class="o">=</span>
</pre></div>


<h2>Deploying the Flask application</h2>
<h3>Step 1 - Copying the source code to the server</h3>
<p>To being our deployment, we need to have our source code on the server. There are several ways to do this. For instance, we can install <code>git</code> on the server and run a <code>git clone</code>. However, to keep things simple, we will be copying the relevant files from our local computer to the server using the <code>scp</code> command.</p>
<p>The current git repository contains some directories (like tests) and configuration files that are not really needed to run our application in its current state. We will, therefore, be excluding those. Here is the list of directories and files that will be copied over.</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">Structure</span> <span class="k">of</span> <span class="n">the</span> <span class="n">flask_demo</span> <span class="n">folder</span>

<span class="p">.</span>
<span class="err">├──</span> <span class="p">.</span><span class="n">env</span>
<span class="err">├──</span> <span class="n">app</span><span class="p">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">commands</span><span class="p">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">config</span><span class="p">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">db</span><span class="p">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">forms</span>
<span class="err">├──</span> <span class="n">lm</span><span class="p">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">models</span>
<span class="err">├──</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="err">├──</span> <span class="k">static</span>
<span class="err">├──</span> <span class="n">templates</span>
<span class="err">├──</span> <span class="n">views</span>
<span class="err">└──</span> <span class="n">wsgi</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>The below <code>scp</code> command will be run on our local computer. The command will copy the folder named <em>flask_demo</em> from the local drive to the <em>flaskuser</em>'s home directory on the server. We will need to be in the directory containing <em>flask_demo</em> before running the command.</p>
<div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">-</span><span class="n">r</span> <span class="n">flask_demo</span> <span class="n">flaskuser</span><span class="mf">@206.189.132.233</span><span class="o">:~/</span>
</pre></div>


<h3>Step 2 - Setting up a virtual environment on the VPS</h3>
<p>To verify if <strong>Python 3</strong> is installed on the server, execute the <code>python3</code> command on the terminal. If installed, we will see a Python REPL. If not, run <code>sudo apt install python3</code> to install Python.</p>
<p>We will need to create a virtual environment and install the application dependencies from the <em>requirements.txt</em> file. The first step in this process will be to install <code>pip</code> and <code>venv</code>. Note that we can use any preferred packages like <code>virtualenv</code> or <code>pipenv</code> to create a virtual environment.</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">pip</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">venv</span>
</pre></div>


<p>To create the virtual environment we will use <code>python3 -m venv flask_demo/venv</code> and to activate the virtual environment, we will <code>cd</code> into the <em>flask_demo</em> directory and run <code>source venv/bin/activate</code>.</p>
<p>Finally, we will install the packages specific to our application from the requirements file using <code>pip install -r requirements.txt</code>.</p>
<p>With the virtual environment now set up, let's perform a quick test to see if our flask application runs without any errors. We will do this by first setting the <code>FLASK_APP</code> environment variable and then using <code>flask run</code> to run the application. To check if everything is working as expected, we can access the url <a href="http://206.189.132.233:5000">http://206.189.132.233:5000</a>. This should render the application in the browser. However, as mentioned above, this is simply a test. We will be disabling port 5000 in a later step.</p>
<div class="highlight"><pre><span></span><span class="ss">(</span><span class="nv">venv</span><span class="ss">)</span> <span class="nv">flaskuser</span>@<span class="nv">Flask</span><span class="o">-</span><span class="nv">Demo</span><span class="o">-</span><span class="nv">Server</span>:<span class="o">~/</span><span class="nv">flask_demo</span>$ <span class="nv">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span><span class="nv">app</span>.<span class="nv">py</span>
<span class="ss">(</span><span class="nv">venv</span><span class="ss">)</span> <span class="nv">flaskuser</span>@<span class="nv">Flask</span><span class="o">-</span><span class="nv">Demo</span><span class="o">-</span><span class="nv">Server</span>:<span class="o">~/</span><span class="nv">flask_demo</span>$ <span class="nv">flask</span> <span class="nv">run</span> <span class="o">--</span><span class="nv">host</span><span class="o">=</span><span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>
 <span class="o">*</span> <span class="nv">Serving</span> <span class="nv">Flask</span> <span class="nv">app</span> <span class="s2">&quot;</span><span class="s">app.py</span><span class="s2">&quot;</span>
 <span class="o">*</span> <span class="nv">Environment</span>: <span class="nv">production</span>
   <span class="nv">WARNING</span>: <span class="nv">This</span> <span class="nv">is</span> <span class="nv">a</span> <span class="nv">development</span> <span class="nv">server</span>. <span class="k">Do</span> <span class="nv">not</span> <span class="nv">use</span> <span class="nv">it</span> <span class="nv">in</span> <span class="nv">a</span> <span class="nv">production</span> <span class="nv">deployment</span>.
   <span class="nv">Use</span> <span class="nv">a</span> <span class="nv">production</span> <span class="nv">WSGI</span> <span class="nv">server</span> <span class="nv">instead</span>.
 <span class="o">*</span> <span class="nv">Debug</span> <span class="nv">mode</span>: <span class="nv">off</span>
 <span class="o">*</span> <span class="nv">Running</span> <span class="nv">on</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">0</span>:<span class="mi">5000</span><span class="o">/</span> <span class="ss">(</span><span class="nv">Press</span> <span class="nv">CTRL</span><span class="o">+</span><span class="nv">C</span> <span class="nv">to</span> <span class="nv">quit</span><span class="ss">)</span>
</pre></div>


<p>Testing the application this way assures us that we will not run into any code related issues later on. For instance, say we missed copying a file or did not configure an environment variable correctly, then this test will help us identify such issues.</p>
<h3>Step 3 - Configuring NGINX</h3>
<p>To serve the static content (HTML, CSS, JavaScript) of our website, we will be using <strong>NGINX</strong> as our webserver.</p>
<p>To install NGINX, we will run <code>sudo apt install nginx</code>.</p>
<p>To configure NGINX for our application, we will need to create a configuration file which will allow the web server and our application to talk to each other. First, we will delete the default NGINX configuration file that was created during the installation process.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="k">default</span><span class="w"></span>
</pre></div>


<p>Next, we will use the <em>nano</em> text editor to create, update and save a new configuration file. Run the below command will open the file in edit mode.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">nano</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">demo</span><span class="w"></span>
</pre></div>


<p>We will now add the below code to the configurtion file.</p>
<div class="highlight"><pre><span></span><span class="nv">server</span> {
        <span class="nv">listen</span> <span class="mi">80</span><span class="c1">;</span>
        <span class="nv">server_name</span> <span class="mi">206</span>.<span class="mi">189</span>.<span class="mi">132</span>.<span class="mi">233</span><span class="c1">;</span>

        <span class="nv">location</span> <span class="o">/</span><span class="nv">static</span> {
                <span class="nv">alias</span> <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">flaskuser</span><span class="o">/</span><span class="nv">flask_demo</span><span class="o">/</span><span class="nv">static</span><span class="c1">;</span>
        }

        <span class="nv">location</span> <span class="o">/</span> {
                <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="nv">localhost</span>:<span class="mi">8000</span><span class="c1">;</span>
                <span class="k">include</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">proxy_params</span><span class="c1">;</span>
                <span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
        }
}
</pre></div>


<p>Once we add this code, we can hit <code>Ctrl + X</code>, <code>Y</code> and <code>Enter</code> to save and close the file.</p>
<p>Let's go over this file -
1. First, we are instructing NGINX to listen for our application traffic on http port 80 of our VPS
2. Next, we are telling NGINX where to look for the static content of our Flask application by providing the path to the <code>static</code> directory as an alias
3. With the static content taken care of, NGINX will pass any request processed at the root (<a href="http://206.189.132.233">http://206.189.132.233</a>) of our application to the proxied server specified in the <code>proxy pass</code> directive. This proxied server in our case is <code>gunicorn</code> running on the default port 8000
4. The <code>proxy_params</code> file specifies some standard parameters to be used by the proxied server and <code>proxy_redirect off</code> turns off any redirects</p>
<p>Although we have set up NGINX to listen on port 80, our firewall has not been opened for that port. To allow traffic on port 80, we will run <code>sudo ufw allow http/tcp</code>.</p>
<div class="highlight"><pre><span></span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ufw</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">http</span><span class="o">/</span><span class="n">tcp</span><span class="w"></span>

<span class="k">Rule</span><span class="w"> </span><span class="n">added</span><span class="w"></span>
<span class="k">Rule</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>Next, we will no longer allow application traffic on port 5000 which we previously used for testing - <code>sudo ufw delete allow 5000</code>.</p>
<div class="highlight"><pre><span></span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ufw</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="mi">5000</span><span class="w"></span>

<span class="k">Rule</span><span class="w"> </span><span class="n">deleted</span><span class="w"></span>
<span class="k">Rule</span><span class="w"> </span><span class="n">deleted</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>Finally, we will run <code>sudo ufw enable</code> to persist the firewall related changes.</p>
<div class="highlight"><pre><span></span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ufw</span><span class="w"> </span><span class="n">enable</span><span class="w"></span>

<span class="n">Command</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">disrupt</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="n">ssh</span><span class="w"> </span><span class="n">connections</span><span class="p">.</span><span class="w"> </span><span class="n">Proceed</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">operation</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="o">|</span><span class="n">n</span><span class="p">)</span><span class="vm">?</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<span class="n">Firewall</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">enabled</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="n">startup</span><span class="w"></span>
</pre></div>


<p><code>sudo ufw status</code> will show us the current ports allowed by the firewall.</p>
<div class="highlight"><pre><span></span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">ufw</span><span class="w"> </span><span class="n">status</span><span class="w"></span>

<span class="nl">Status</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="w"></span>

<span class="k">To</span><span class="w">                         </span><span class="k">Action</span><span class="w">      </span><span class="k">From</span><span class="w"></span>
<span class="c1">--                         ------      ----</span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span><span class="w">                     </span><span class="n">ALLOW</span><span class="w">       </span><span class="n">Anywhere</span><span class="w"></span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span><span class="w">                     </span><span class="n">ALLOW</span><span class="w">       </span><span class="n">Anywhere</span><span class="w"></span>
<span class="mi">22</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w">                </span><span class="n">ALLOW</span><span class="w">       </span><span class="n">Anywhere</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w"></span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w">                </span><span class="n">ALLOW</span><span class="w">       </span><span class="n">Anywhere</span><span class="w"> </span><span class="p">(</span><span class="n">v6</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>We will now restart NGINX to make sure all the changes made in this section are saved and enabled.</p>
<div class="highlight"><pre><span></span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">nginx</span><span class="w"></span>
</pre></div>


<h3>Step 4 - Configuring gunicorn</h3>
<p>While NGINX serves the static content of our application, <code>gunicorn</code> handles the Python code. To install <code>gunicorn</code>, we will run <code>pip install gunicorn</code> on the server with the virtual environment activated.</p>
<p>To run <code>gunicorn</code> we need to specify the exact module name where the Flask application is created. Our code uses the <code>create_app</code> factory method which returns the Flask application. Also included in our code is the <code>wsgi.py</code> module that calls the factory method and stores the application in a variable named <code>app</code>.</p>
<div class="highlight"><pre><span></span><span class="c1"># wsgi.py </span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">config_class</span><span class="o">=</span><span class="n">Config</span><span class="p">)</span>
</pre></div>


<p>The command <code>gunicorn -w 3 wsgi:app</code> will start <code>gunicorn</code> on our server. We need to make sure that we are in the application folder while running this command.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">~/</span><span class="n">flask_demo</span><span class="err">$</span><span class="w"> </span><span class="n">gunicorn</span><span class="w"> </span><span class="o">-</span><span class="n">w</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nl">wsgi</span><span class="p">:</span><span class="n">app</span><span class="w"></span>

<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14100</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">gunicorn</span><span class="w"> </span><span class="mf">19.9.0</span><span class="w"></span>
<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14100</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Listening</span><span class="w"> </span><span class="k">at</span><span class="err">:</span><span class="w"> </span><span class="nl">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="err">:</span><span class="mi">8000</span><span class="w"> </span><span class="p">(</span><span class="mi">14100</span><span class="p">)</span><span class="w"></span>
<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14100</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="nl">worker</span><span class="p">:</span><span class="w"> </span><span class="n">sync</span><span class="w"></span>
<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14103</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Booting</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">pid</span><span class="p">:</span><span class="w"> </span><span class="mi">14103</span><span class="w"></span>
<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14104</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Booting</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">pid</span><span class="p">:</span><span class="w"> </span><span class="mi">14104</span><span class="w"></span>
<span class="o">[</span><span class="n">2019-12-11 09:20:43 +0000</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">14105</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">INFO</span><span class="o">]</span><span class="w"> </span><span class="n">Booting</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nl">pid</span><span class="p">:</span><span class="w"> </span><span class="mi">14105</span><span class="w"></span>
</pre></div>


<p>The <code>-w</code> parameter specifies the number of worker processes which is 3 in our case. The general rule of thumb is to use the formula <code>(2 x number of CPU cores) + 1</code>.  The command <code>nproc --all</code> will give us the number of CPU cores.</p>
<p>At this point, we can access our application on <a href="http://206.189.132.233">http://206.189.132.233</a>.</p>
<p><br />
<img alt="site" src="https://codedisciples.in/images/index16/site.jpg"></p>
<p>However, note that <code>gunicorn</code> is running in the foreground. In other words, if we were to close the terminal, our site would no longer be accessible. To avoid this, we will install a package called <code>supervisor</code> which will monitor <code>gunicorn</code> and keep it running as a daemon process.</p>
<h3>Step 5 - Configuring supervisor and logging</h3>
<p>To install <code>supervisor</code> on the server, we will run <code>sudo apt install supervisor</code>.</p>
<p>Next, we will create a configuration file that will tell <code>supervisor</code> to run <code>gunicorn</code> and start it back up in case it stops for some reason. The file will also contain the paths to our standard output and error logs.</p>
<p>Once again, we will create this file (flask-demo.conf) using <code>nano</code> and add the lines of code indicated below - <code>nano /etc/supervisor/conf.d/flask-demo.conf</code>. To save the file - <code>Ctrl + X</code>, <code>Y</code> and <code>Enter</code>.</p>
<div class="highlight"><pre><span></span><span class="k">[program:flask_demo]</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/home/flaskuser/flask_demo</span>
<span class="na">command</span><span class="o">=</span><span class="s">/home/flaskuser/flask_demo/venv/bin/gunicorn -w 3 wsgi:app</span>
<span class="na">user</span><span class="o">=</span><span class="s">flaskuser</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">stopasgroup</span><span class="o">=</span><span class="s">true</span>
<span class="na">killasgroup</span><span class="o">=</span><span class="s">true</span>
<span class="na">stderr_logfile</span><span class="o">=</span><span class="s">/var/log/flask_demo/flask-demo.err.log</span>
<span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/var/log/flask_demo/flask-demo.out.log</span>
</pre></div>


<p>The final steps in our deployment will be to create the log files that we configured in the<code>supervisor</code> configuration file followed by restarting <code>supervisor</code>.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">/</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">flask_demo</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="n">err</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>
<span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">/</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">touch</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="nf">log</span><span class="o">/</span><span class="n">flask_demo</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="nf">log</span><span class="w"></span>
</pre></div>


<p>To restart supervisor - <code>sudo supervisorctl reload</code>.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">flaskuser</span><span class="nv">@Flask</span><span class="o">-</span><span class="n">Demo</span><span class="o">-</span><span class="nl">Server</span><span class="p">:</span><span class="o">/</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">supervisorctl</span><span class="w"> </span><span class="n">reload</span><span class="w"></span>
<span class="n">Restarted</span><span class="w"> </span><span class="n">supervisord</span><span class="w"></span>
</pre></div>


<p>We will now be able to access our website in spite of disconnecting from our terminal. </p>
<p>That's it! We now have a fully functional Flask site running in production. As next steps, we can add a custom domain and secure our site by adding https. Those, however, are out of scope in this post. In a future post, we will see how to install and set up a PostgreSQL database on the server for our application rather than using ElephantSQL.</p>
  </div>
  
  <br/>
  <div class="comments">
  <h2>Share</h2>
  <br/>
  <!-- AddToAny BEGIN -->
    <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
      <a class="a2a_button_blogger"></a>
      <a class="a2a_button_email"></a>
      <a class="a2a_button_flipboard"></a>
      <a class="a2a_button_google_gmail"></a>
      <a class="a2a_button_hacker_news"></a>
      <a class="a2a_button_linkedin"></a> 
      <a class="a2a_button_reddit"></a>
      <a class="a2a_button_telegram"></a>
      <a class="a2a_button_twitter"></a>
      <a class="a2a_button_whatsapp"></a>
      <a class="a2a_button_wordpress"></a>
    </div>
    <script async src="https://static.addtoany.com/menu/page.js"></script>
  <!-- AddToAny END -->
  </div>
  <br/>
  <div class="comments">
	<h2>Comments</h2>
	<div id="disqus_thread"></div>
	<script type="text/javascript">
				   (function() {
						var dsq = document.createElement('script');
						dsq.type = 'text/javascript'; dsq.async = true;
						dsq.src = '//code-disciples.disqus.com/embed.js';
						(document.getElementsByTagName('head')[0] ||
						 document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
	</script>
  </div>

</article>
        </div><!-- /content -->

        <div class="col-md-3 sidebar-nav" id="sidebar">

<div class="row">


<div class="col-xs-6 col-md-12">
<h4><i class="fas fa-folder fa-fw fa-lg"></i> Categories</h4>
<ul class="list-unstyled category-links">
  <li><a href="https://codedisciples.in/category/docker.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Docker</a></li>
  <li><a href="https://codedisciples.in/category/flask.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Flask</a></li>
  <li><a href="https://codedisciples.in/category/git.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Git</a></li>
  <li><a href="https://codedisciples.in/category/linux.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Linux</a></li>
  <li><a href="https://codedisciples.in/category/python.html" >
    <i class="fas fa-folder-open fa-fw fa-lg"></i> Python</a></li>
</ul>
</div>

</div> <!-- /row -->

<h4><i class="fas fa-tags fa-fw fa-lg"></i> Tags</h4>
<p class="tag-cloud">
      <a href="https://codedisciples.in/tag/python.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Python
      </a>
      <a href="https://codedisciples.in/tag/linux.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Linux
      </a>
      <a href="https://codedisciples.in/tag/flask.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Flask
      </a>
      <a href="https://codedisciples.in/tag/heroku.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Heroku
      </a>
      <a href="https://codedisciples.in/tag/celery.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Celery
      </a>
      <a href="https://codedisciples.in/tag/git.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Git
      </a>
      <a href="https://codedisciples.in/tag/docker.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Docker
      </a>
      <a href="https://codedisciples.in/tag/postgres.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Postgres
      </a>
      <a href="https://codedisciples.in/tag/google-maps.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Google Maps
      </a>
      <a href="https://codedisciples.in/tag/aws.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>AWS
      </a>
      <a href="https://codedisciples.in/tag/jupyter.html">
        <i class="fas fa-tag fa-fw fa-lg"></i>Jupyter
      </a>
</p>

<hr />

        </div><!--/sidebar -->
      </div><!--/row-->
    </div><!--/.container /#main-container -->
    <br>
    <footer id="site-footer">
 
      <address id="site-colophon">
        <p class="text-center text-muted">
        Built with <img id="footer-image" src="/static/images/love.ico"> in Bangalore&nbsp;&bull;&nbsp; Powered by <a href="http://getpelican.com/" target="_blank">Pelican</a> and <a href="https://www.netlify.com"
           target="_blank">Netlify</a>
        </p>
      </address><!-- /colophon  -->
    </footer>

<!-- DISQUS script for displaying comment count -->
<script type="text/javascript">
    var disqus_shortname = 'code-disciples';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    <!-- javascript -->
   
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>


  </body>
</html>